$(document).on 'turbolinks:load', ->

  readURL = (input) ->
    if input.files.length > 0
      i = 0
      uploadFile = () ->
        console.log "nova iteracao"
        li = document.createElement("li")
        li.className = "list-inline-item"
        spinner = document.createElement("i")
        spinner.className = "fa fa-spinner fa-pulse fa-2x fa-fw"
        li.appendChild(spinner)
        document.getElementById("uploaded_property_images").appendChild(li);

        reader = new FileReader()
        formData = new FormData();
        formData.append("property[image]", input.files[i]);

        reader.onload = (e) ->
          $.ajax '/properties/add_images',
          beforeSend: (xhr) ->
            xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))
          data: file,
          cache: false,
          contentType: false,
          processData: false,
          method: 'POST',
          success: () ->
            uploadFile()
            console.log "teste"

          li.removeChild(spinner)
          div = document.createElement("div")
          div.style.backgroundImage = "url(" + e.target.result + ")"
          li.appendChild(div)

        doLoop()
        reader.readAsDataURL(file)

  $("#property_images").change (e) ->
    readURL(this)

  return
